<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Шиномонтаж</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Шиномонтаж</h1>
    <button id="logoutBtn" class="hidden" onclick="logout()">Выйти</button>
  </header>

  <!-- === Запись === -->
  <div class="card">
    <h2>Запись</h2>
    <div class="form-row">
      <input type="text" id="guestName" placeholder="Имя">
      <input type="text" id="guestPhone" placeholder="Телефон">
      <select id="guestCarType">
        <option>Легковая</option>
        <option>Кроссовер</option>
        <option>Внедорожник</option>
        <option>Микроавтобус</option>
        <option>Грузовые</option>
        <option>Коммерческий транспорт</option>
      </select>
      <select id="radiusSelect">
        <option>R13</option>
        <option>R14</option>
        <option>R15</option>
        <option>R16</option>
        <option>R17</option>
        <option>R18</option>
        <option>R19</option>
        <option>R20</option>
        <option>R21</option>
      </select>
      <select id="serviceSelect">
        <option>Балансировка</option>
        <option>Смена резины</option>
        <option>Смена резины с балансировкой</option>
      </select>
      <input type="date" id="guestDate" min="">
      <div>Цена от: <span id="priceDisplay">-</span> грн</div>
      <button onclick="addGuestRecord()">Записаться</button>
    </div>
  </div>

  <!-- === Вход === -->
  <div class="card" id="loginCard">
    <h2>Вход</h2>
    <input type="text" id="loginInput" placeholder="Логин">
    <input type="password" id="passwordInput" placeholder="Пароль">
    <button onclick="login()">Войти</button>
  </div>

  <!-- === Кабинет работника === -->
  <div class="card hidden" id="workerCard">
    <h2>Кабинет работника</h2>
    <div id="workerRecords"></div>
  </div>

  <!-- === Кабинет босса === -->
  <div class="card hidden" id="bossCard">
    <h2>Кабинет босса</h2>
    <div class="top-actions">
      <button onclick="setBossFilter('day')">День</button>
      <button onclick="setBossFilter('week')">Неделя</button>
      <button onclick="setBossFilter('month')">Месяц</button>
    </div>
    <div id="bossRecords"></div>
    <div id="bossTotal">Сумма: 0 грн</div>
  </div>
</div>

<script>
// ==== Supabase ====
const supabaseUrl = 'https://bmasqfcvjwydpwlqqmcu.supabase.co';
const supabaseKey = 'sb_publishable_vd51ZeFzGmbof7TY5ZDoUg_z-dak7Jg';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

let currentUser = null;
let bossFilter = 'day';

// ==== Цены ====
const priceTable = {
  'Легковая': { '13-15': {balance:400, full:600}, '16-18': {balance:480, full:720}, '19-21': {balance:560, full:840} },
  'Кроссовер': { '13-15': {balance:440, full:680}, '16-18': {balance:520, full:800}, '19-21': {balance:600, full:920} },
  'Внедорожник': { '13-15': {balance:480, full:740}, '16-18': {balance:560, full:860}, '19-21': {balance:640, full:980} },
  'Микроавтобус': { '13-15': {balance:440, full:680}, '16-18': {balance:520, full:800}, '19-21': {balance:600, full:920} },
  'Грузовые': { '13-15': {balance:480, full:740}, '16-18': {balance:560, full:860}, '19-21': {balance:640, full:980} },
  'Коммерческий транспорт': {}
};

function getRadiusRange(radius){
  const r = parseInt(radius.replace('R',''));
  if(r>=13 && r<=15) return '13-15';
  if(r>=16 && r<=18) return '16-18';
  if(r>=19 && r<=21) return '19-21';
  return '';
}

function updatePrice(){
  const car = document.getElementById('guestCarType').value;
  const radius = document.getElementById('radiusSelect').value;
  const service = document.getElementById('serviceSelect').value;
  const range = getRadiusRange(radius);
  let priceText = '-';
  if(priceTable[car] && priceTable[car][range]){
    if(service.includes('Балансировка') && service.includes('с')) priceText = priceTable[car][range].full;
    else if(service.includes('Балансировка')) priceText = priceTable[car][range].balance;
  }
  document.getElementById('priceDisplay').innerText = priceText;
}
document.getElementById('guestCarType').addEventListener('change', updatePrice);
document.getElementById('radiusSelect').addEventListener('change', updatePrice);
document.getElementById('serviceSelect').addEventListener('change', updatePrice);

// ==== Минимальная дата ====
document.getElementById('guestDate').min = new Date().toISOString().split('T')[0];

// ==== Добавление записи ====
async function addGuestRecord(){
  const name = document.getElementById('guestName').value.trim();
  const phone = document.getElementById('guestPhone').value.trim();
  const car = document.getElementById('guestCarType').value;
  const radius = document.getElementById('radiusSelect').value;
  const service = document.getElementById('serviceSelect').value;
  const date = document.getElementById('guestDate').value;

  if(!name || !phone || !date){
    alert('Заполните все поля!');
    return;
  }

  const { data, error } = await supabase
    .from('records')
    .insert([{ name, phone, car, radius, service, date, status:'Не отмечено', addedBy:'Гость', earned:0 }]);

  if(error){ console.log(error); alert('Ошибка при добавлении'); }
  else { alert('Запись добавлена!'); }
}

// ==== Вход ====
async function login(){
  const loginVal = document.getElementById('loginInput').value.trim();
  const passVal = document.getElementById('passwordInput').value.trim();

  const { data, error } = await supabase
    .from('users')
    .select('*')
    .eq('login', loginVal)
    .eq('password', passVal)
    .single();

  if(error || !data){ alert('Неверный логин или пароль'); return; }

  currentUser = data;
  document.getElementById('logoutBtn').classList.remove('hidden');
  document.getElementById('loginCard').classList.add('hidden');

  if(data.role==='boss'){ document.getElementById('bossCard').classList.remove('hidden'); fetchBossRecords(); }
  else{ document.getElementById('workerCard').classList.remove('hidden'); fetchWorkerRecords(); }
}

function logout(){
  currentUser=null;
  document.getElementById('bossCard').classList.add('hidden');
  document.getElementById('workerCard').classList.add('hidden');
  document.getElementById('logoutBtn').classList.add('hidden');
  document.getElementById('loginCard').classList.remove('hidden');
}

// ==== Получение записей для боса ====
async function fetchBossRecords(){
  const { data, error } = await supabase.from('records').select('*');
  const container = document.getElementById('bossRecords');
  container.innerHTML = '';
  let total = 0;
  data.forEach(r=>{
    const range = getRadiusRange(r.radius);
    let price=0;
    if(priceTable[r.car] && priceTable[r.car][range]){
      if(r.service.includes('Балансировка') && r.service.includes('с')) price=priceTable[r.car][range].full;
      else if(r.service.includes('Балансировка')) price=priceTable[r.car][range].balance;
    }
    total += price + (r.earned || 0);
    const div = document.createElement('div');
    div.className='record';
    div.innerHTML = `<b>${r.name}</b> | ${r.phone} | ${r.car} | ${r.radius} | ${r.service} | ${r.date}
      <div class="meta">Статус: ${r.status} | Отметил: ${r.addedBy} | Цена: ${price} | Заработано: ${r.earned || 0}</div>
      <button onclick="deleteRecord(${r.id})">Удалить</button>`;
    container.appendChild(div);
  });
  document.getElementById('bossTotal').innerText='Сумма: '+total+' грн';
}

async function deleteRecord(id){
  await supabase.from('records').delete().eq('id',id);
  fetchBossRecords();
}

// ==== Кабинет работника ====
async function fetchWorkerRecords(){
  const { data } = await supabase.from('records').select('*');
  const container = document.getElementById('workerRecords');
  container.innerHTML='';
  data.forEach(r=>{
    const div = document.createElement('div');
    div.className='record';
    div.innerHTML=`<b>${r.name}</b> | ${r.phone} | ${r.car} | ${r.radius} | ${r.service} | ${r.date}
      <div class="meta">Статус: ${r.status} | Отметил: ${r.addedBy} | Заработано: ${r.earned || 0}</div>
      <button onclick="markRecord(${r.id},'Сделано')">Приехал</button>
      <button onclick="markRecord(${r.id},'Не приехал')">Не приехал</button>
      <button onclick="addWork(${r.id})">Добавить цену</button>`;
    container.appendChild(div);
  });
}

async function markRecord(id,status){
  await supabase.from('records').update({status:status, addedBy:currentUser.login}).eq('id',id);
  fetchWorkerRecords();
  if(currentUser.role==='boss') fetchBossRecords();
}

async function addWork(id){
  const earnedStr = prompt('Сколько заработано (грн)?');
  const earned = parseFloat(earnedStr);
  if(isNaN(earned)) return alert('Введите число');
  await supabase.from('records').update({earned:earned, addedBy:currentUser.login}).eq('id',id);
  fetchWorkerRecords();
  if(currentUser.role==='boss') fetchBossRecords();
}

function setBossFilter(f){ bossFilter=f; fetchBossRecords(); }
</script>
</body>
</html>
